# create binary on windows 

name: build_binaries

on:
    push:
        branches: [ "main", "189-on-pull-request-or-push-on-main-send-new-binaries-to-windows-installer" ]
    pull_request:
        branches: [ "main" ]
    
jobs:

    # ---------------------------------------------------------------------------
    build_windows:
        runs-on: windows-latest
        steps:
            - name: Checkout project
              uses: actions/checkout@v4

            - name: Display cargo version
              run: cargo --version
            
            - name: Try to Build
              run: cargo build --verbose --release
            
            # Release version is supposed to have a faster runtime than debug
            - name: Upload windows binaries release
              uses: actions/upload-artifact@v4
              with:
                  name: windows_binaries
                  path: target/release/panduza-rust-platform.exe

            - name: Start Windows installer workflow
              uses: peter-evans/repository-dispatch@v1
              with:
                token: ${{ secrets.TOKEN_WINDOWS_INSTALLER }}
                repository: Panduza/panduza_windows_installer 
                event-type: update-windows-installer
                client-payload: '{"ref": "${{ github.ref }}"}'

    
    # Fast hook test, send a message to windows installer repo to start his workflow
    # p
    test_hook:

        runs-on: windows-latest

        steps:

        - name: Start Windows installer workflow
          uses: peter-evans/repository-dispatch@v1
          with:
            token: ${{ secrets.TOKEN_WINDOWS_INSTALLER }}
            repository: Panduza/panduza_windows_installer 
            event-type: update-windows-installer
            client-payload: '{"ref": "${{ github.ref }}"}'